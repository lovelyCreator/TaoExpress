import { 
  Product, 
  Category, 
  Seller, 
  Review, 
  Story, 
  Notification, 
  User, 
  Order, 
  CartItem,
  SearchFilters, 
  ApiResponse, 
  PaginatedResponse,
  VariationData,
  ShippingService
} from '../types';
import * as LocalDB from './localDatabase';
import { getStoredToken } from './authApi';
import axios, { AxiosRequestConfig } from 'axios';
import { uploadToCloudinary, uploadVideoToCloudinary } from './cloudinary';

// Initialize local database on app start
// Initialize local database with a small delay to prevent race conditions
setTimeout(() => {
  LocalDB.initializeLocalDatabase().catch(error => {
    console.error('Failed to initialize local database:', error);
  });
}, 100);

// API base URL - using environment variable with fallback to local endpoint
const API_BASE_URL = process.env.REACT_APP_API_BASE_URL || 'https://semistiff-vance-doctorly.ngrok-free.dev/api/v1';

// Helper function to get auth headers
const getAuthHeaders = async () => {
  const token = await getStoredToken();
  // console.log('API: Retrieved token for request:', token ? 'Token exists' : 'No token');
  return {
    'Authorization': `Bearer ${token}`,
  };
};

// Define interfaces for product creation/update data
interface ProductCreateData {
  name: string;
  description: string;
  category_id: number;
  price: number;
  current_stock: number;
  weight: number;
  height: number;
  width: number;
  length: number;
  store_id: number;
  shipping_options: number;
  item_images: string[];
  videos: string[];
  variations: {
    name: string;
    options: {
      value: string;
      price: number;
      stock: number;
    }[];
  }[];
  [key: string]: any; // Allow additional properties
}

interface ProductUpdateData extends ProductCreateData {
  id: string;
}

// Helper function to convert string to number safely
const toNumber = (value: string | number | undefined, defaultValue: number = 0): number => {
  if (typeof value === 'number') return value;
  if (typeof value === 'string') {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? defaultValue : parsed;
  }
  return defaultValue;
};

// Helper function to convert string to integer safely
const toInteger = (value: string | number | undefined, defaultValue: number = 0): number => {
  if (typeof value === 'number') return Math.floor(value);
  if (typeof value === 'string') {
    const parsed = parseInt(value, 10);
    return isNaN(parsed) ? defaultValue : parsed;
  }
  return defaultValue;
};

// Products API
export const productsApi = {
  // Get products with pagination and filters
  getProducts: async (
    page: number = 1,
    limit: number = 20,
    filters?: SearchFilters
  ): Promise<PaginatedResponse<Product>> => {
    return await LocalDB.getProducts(page, limit, filters);
  },

  // Get product by ID
  getProductById: async (id: string): Promise<ApiResponse<Product>> => {
    const product = await LocalDB.getProductById(id);
    if (!product) {
      return {
        success: false,
        message: 'Product not found',
        data: null as any,
      };
    }
    return {
      success: true,
      data: product,
    };
  },

  // Get "You May Like" products
  getYouMayLikeProducts: async (productId: string, limit: number = 8): Promise<ApiResponse<Product[]>> => {
    const result = await LocalDB.getYouMayLikeProducts(productId, limit);
    return {
      success: true,
      data: result,
    };
  },

  // Get featured products
  getFeaturedProducts: async (limit: number = 10): Promise<ApiResponse<Product[]>> => {
    const result = await LocalDB.getFeaturedProducts(limit);
    return {
      success: true,
      data: result.data,
    };
  },

  // Get new products
  getNewProducts: async (limit: number = 10): Promise<ApiResponse<Product[]>> => {
    const result = await LocalDB.getNewProducts(limit);
    return {
      success: true,
      data: result.data,
    };
  },

  // Get sale products
  getSaleProducts: async (limit: number = 10): Promise<ApiResponse<Product[]>> => {
    const result = await LocalDB.getSaleProducts(limit);
    return {
      success: true,
      data: result.data,
    };
  },

  // Search products
  searchProducts: async (
    query: string,
    page: number = 1,
    limit: number = 20,
    filters?: SearchFilters
  ): Promise<PaginatedResponse<Product>> => {
    return await LocalDB.searchProducts(query, page, limit, filters);
  },

  // Create a new product
  createProduct: async (productFormData: FormData): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('=== CREATE PRODUCT START ===');
      // console.log('Processing product FormData: ' + token);
      
      // Extract data from FormData
      const productData: Partial<ProductCreateData> = {};
      const images: string[] = [];
      const videos: string[] = [];
      let variationsData: string | null = null;
      
      // @ts-ignore
      const entries = [...productFormData.entries()];
      for (const [key, value] of entries) {
        // console.log('FormData key:', key, 'value:', value);
        
        if (key.startsWith('item_images[')) {
          images.push(value as string);
        } else if (key.startsWith('videos[')) {
          videos.push(value as string);
        } else if (key === 'variations') {
          variationsData = value as string;
        } else {
          // Convert string values to appropriate types
          switch (key) {
            case 'category_id':
            case 'store_id':
            case 'shipping_options':
              productData[key as keyof ProductCreateData] = toInteger(value as string);
              break;
            case 'price':
            case 'current_stock':
            case 'weight':
            case 'height':
            case 'width':
            case 'length':
              productData[key as keyof ProductCreateData] = toNumber(value as string);
              break;
            default:
              productData[key as keyof ProductCreateData] = value as any;
              break;
          }
        }
      }
      
      // Add media arrays
      if (images.length > 0) {
        productData.item_images = images;
      }
      
      if (videos.length > 0) {
        productData.videos = videos;
      }
      
      // Parse variations if present
      if (variationsData) {
        try {
          const parsedVariations = JSON.parse(variationsData);
          // Ensure proper typing for variations
          productData.variations = parsedVariations.map((variation: any) => ({
            name: variation.name,
            options: variation.options.map((option: any) => ({
              value: option.value,
              image: option.image || '',
              price: toNumber(option.price),
              stock: toInteger(option.stock),
            }))
          }));
        } catch (parseError) {
          console.error('Error parsing variations data:', parseError);
        }
      }
      
      // console.log('Sending product creation request to:', `${API_BASE_URL}/vendor/item/store`);
      // console.log('Product data:', productData);
      
      // Send request using Axios with proper typing
      const response = await axios.post(
        `${API_BASE_URL}/vendor/item/store`,
        productData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Product created successfully',
      };
    } catch (error: any) {
      console.error('Create product error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to create product. Status: ${error.response.status}`,
          data: null,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },

  // Update an existing product
  updateProduct: async (productFormData: FormData): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('=== UPDATE PRODUCT START ===');
      // console.log('Processing product FormData');
      
      // Extract data from FormData
      const productData: Partial<ProductUpdateData> = {};
      const images: string[] = [];
      const videos: string[] = [];
      let variationsData: string | null = null;
      
      // @ts-ignore
      const entries = [...productFormData.entries()];
      for (const [key, value] of entries) {
        // console.log('FormData key:', key, 'value:', value);
        
        if (key.startsWith('item_images[')) {
          images.push(value as string);
        } else if (key.startsWith('videos[')) {
          videos.push(value as string);
        } else if (key === 'variations') {
          variationsData = value as string;
        } else {
          // Convert string values to appropriate types
          switch (key) {
            case 'id':
              productData[key as keyof ProductUpdateData] = value as string;
              break;
            case 'category_id':
            case 'store_id':
            case 'shipping_options':
              productData[key as keyof ProductUpdateData] = toInteger(value as string);
              break;
            case 'price':
            case 'current_stock':
            case 'weight':
            case 'height':
            case 'width':
            case 'length':
            case 'discount':
              productData[key as keyof ProductUpdateData] = toNumber(value as string);
              break;
            default:
              productData[key as keyof ProductUpdateData] = value as any;
              break;
          }
        }
      }
      
      // Add media arrays
      if (images.length > 0) {
        productData.item_images = images;
      }
      
      if (videos.length > 0) {
        productData.videos = videos;
      }
      
      // Parse variations if present
      if (variationsData) {
        try {
          const parsedVariations = JSON.parse(variationsData);
          // Ensure proper typing for variations
          if (Array.isArray(parsedVariations)) {
            productData.variations = parsedVariations.map((variation: any) => ({
              name: variation.name,
              options: variation.options.map((option: any) => ({
                value: option.value,
                price: toNumber(option.price),
                stock: toInteger(option.stock),
              }))
            }));
          }
        } catch (parseError) {
          console.error('Error parsing variations data:', parseError);
        }
      }
      
      // console.log('Sending product update request to:', `${API_BASE_URL}/vendor/item/update`);
      // console.log('Product data:', productData);
      
      // Send request using Axios with PUT method
      const response = await axios.put(
        `${API_BASE_URL}/vendor/item/update`,
        productData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Product updated successfully',
      };
    } catch (error: any) {
      console.error('Update product error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to update product. Status: ${error.response.status}`,
          data: null,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },

  // Get product details by ID
  getProductDetails: async (productId: string): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending product details request to:', `${API_BASE_URL}/items/details/${productId}`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/items/details/${productId}`,
      );
      
      // console.log('Response status:', response.status);
      // console.log('Product Detailes Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Product details retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get product details error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get product details. Status: ${error.response.status}`,
          data: null,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },

  // Get products by store ID
  getProductsByStore: async (storeId: number): Promise<ApiResponse<any[]>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending store products request to:', `${API_BASE_URL}/vendor/item/details/${storeId}`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/vendor/item/details/${storeId}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      // The response is an array of products
      const products = Array.isArray(response.data) ? response.data : [response.data];
      
      return {
        success: true,
        data: products,
        message: 'Products retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get products by store error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get products. Status: ${error.response.status}`,
          data: [] as any[],
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: [] as any[],
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: [] as any[],
        };
      }
    }
  },

  // Get latest products by category
  getLatestProductsByCategory: async (
    categoryIds: number[],
    offset: number = 1,
    limit: number = 13,
    type: string = 'all',
    filter: string = '[]',
    ratingCount: string = '',
    minPrice: number = 0.0,
    maxPrice: number = 999999.0,
    search: string = ''
  ): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      
      // Validate categoryId
      if (categoryIds === undefined || categoryIds === null) {
        console.error('Category ID is undefined or null');
        return {
          success: false,
          message: 'Category ID is required',
          data: null,
        };
      }
      
      // Construct the API URL with all query parameters
      const params = new URLSearchParams({
        category_id: JSON.stringify(categoryIds),
        offset: offset.toString(),
        limit: limit.toString(),
        type,
        filter,
        rating_count: ratingCount,
        min_price: minPrice.toString(),
        max_price: maxPrice.toString(),
        search
      });
      
      const url = `${API_BASE_URL}/items/latest?${params.toString()}`;
      
      console.log('Sending get latest products by category request to:', url);
      
      // Send request using Axios
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      // Check if response data exists and is not empty
      if (!response.data) {
        // console.log('No response data received, falling back to local database');
        // Fallback to local database
        // const result = await LocalDB.getLatestProductsByCategory(
        //   categoryId, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        // );
        return {
          success: true,
          data: { products: [], categories: [] },
          message: 'Latest products retrieved successfully from local database',
        };
      }
      
      // Parse the response data if it's a string
      let parsedData = response.data;
      if (typeof parsedData === 'string') {
        // Check if string is empty or whitespace only
        if (!parsedData.trim()) {
          // console.log('Empty response data received, falling back to local database');
          // Fallback to local database
          // const result = await LocalDB.getLatestProductsByCategory(
          //   categoryId, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
          // );
          return {
            success: false,
            data: { products: [], categories: [] },
            message: 'Latest products retrieved successfully from local database',
          };
        }
        
        let jsonText = parsedData.trim();
        if (!jsonText.endsWith('}')) {
          jsonText += '}';
        }
        try {
          parsedData = JSON.parse(jsonText);
        } catch (parseError) {
          // console.error('Error parsing response data:', parseError);
          // console.log('Raw response data:', parsedData);
          // Fallback to local database
          // const result = await LocalDB.getLatestProductsByCategory(
          //   categoryId, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
          // );
          return {
            success: false,
            data: {products: [], categories: [] },
            message: 'Latest products retrieved successfully from local database',
          };
        }
      }
      
      // Ensure we have the proper structure
      if (parsedData && typeof parsedData === 'object' && !parsedData.products) {
        // If we have a flat structure, wrap it properly
        parsedData = {
          products: Array.isArray(parsedData) ? parsedData : [],
          categories: []
        };
      }
      
      return {
        success: true,
        data: parsedData,
        message: 'Latest products retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get latest products by category error:', error);
      
      // Don't fallback to local database
      return {
        success: false,
        message: `Failed to get latest products: ${error.message || 'Unknown error occurred'}`,
        data: { products: [], categories: [] },
      };
    }
  },

  // Get popular products
  getPopularProducts: async (
    categoryIds: number[],
    offset: number = 1,
    limit: number = 10,
    type: string = 'all',
    filter: string = '[]',
    ratingCount: string = '',
    minPrice: number = 0.0,
    maxPrice: number = 9999999999.0,
    search: string = ''
  ): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      console.log('getPopularProducts: Using token:', token ? 'Token exists' : 'No token');
      
      // Validate categoryIds
      if (!Array.isArray(categoryIds) || categoryIds.length === 0) {
        // console.warn('No category IDs provided for popular products');
        // Fallback to local database with all products
        const result = await LocalDB.getPopularProducts(
          categoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Popular products retrieved successfully from local database',
        };
      }
      
      // Filter out invalid category IDs
      const validCategoryIds = categoryIds.filter(id => id !== undefined && id !== null);
      if (validCategoryIds.length === 0) {
        console.warn('No valid category IDs provided for popular products');
        // Fallback to local database
        const result = await LocalDB.getPopularProducts(
          categoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Popular products retrieved successfully from local database',
        };
      }
      
      // Construct the API URL with all query parameters
      const params = new URLSearchParams({
        offset: offset.toString(),
        limit: limit.toString(),
        type,
        filter,
        rating_count: ratingCount,
        min_price: minPrice.toString(),
        max_price: maxPrice.toString(),
        search,
        category_id: JSON.stringify(validCategoryIds),
      });
      
      // Add category_ids as JSON string
      console.log("validCategoryIds of Populer:", validCategoryIds, filter);
      
      const url = `${API_BASE_URL}/items/popular?${params.toString()}`;
      
      console.log('Sending get popular products request to:', url);
      
      // Send request using Axios
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });
      
      console.log('Popular Response status:', response.status);
      console.log('Popular Response data:', response.data);
      
      // Check if response data exists and is not empty
      if (!response.data) {
        console.log('No response data received, falling back to local database');
        // Fallback to local database
        const result = await LocalDB.getPopularProducts(
          validCategoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Popular products retrieved successfully from local database',
        };
      }
      
      // Parse the response data if it's a string
      let parsedData = response.data;
      if (typeof parsedData === 'string') {
        // Check if string is empty or whitespace only
        if (!parsedData.trim()) {
          console.log('Empty response data received, falling back to local database');
          // Fallback to local database
          const result = await LocalDB.getPopularProducts(
            validCategoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
          );
          return {
            success: true,
            data: { products: result.data, categories: [] },
            message: 'Popular products retrieved successfully from local database',
          };
        }
        let jsonText = parsedData.trim();
        if (!jsonText.endsWith('}')) {
          jsonText += '}';
        }
        try {
          parsedData = JSON.parse(jsonText);
        } catch (parseError) {
          console.error('Error parsing response data:', parseError);
          console.log('Raw response data:', response.data);
          // Fallback to local database
          // const result = await LocalDB.getPopularProducts(
          //   validCategoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
          // );
          return {
            success: false,
            data: { products: [], categories: [] },
            message: 'Popular products retrieved successfully from local database',
          };
        }
      }
      
      console.log("GET POPULER DATA FROM API:", parsedData);
      // Ensure we have the proper structure
      if (parsedData && typeof parsedData === 'object' && !parsedData.products) {
        // If we have a flat structure, wrap it properly
        parsedData = {
          products: Array.isArray(parsedData) ? parsedData : [],
          categories: []
        };
      }
      
      return {
        success: true,
        data: parsedData,
        message: 'Popular products retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get popular products error, falling back to local database:', error);
      
      // Fallback to local database when API fails
      try {
        const result = await LocalDB.getPopularProducts(
          categoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Popular products retrieved successfully from local database',
        };
      } catch (localError) {
        console.error('Local database error:', localError);
        return {
          success: false,
          message: `Failed to get popular products: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },

  // Get most reviewed products
  getMostReviewedProducts: async (
    categoryIds: number[],
    offset: number = 1,
    limit: number = 25,
    type: string = 'all',
    filter: string = '[]',
    ratingCount: string = '',
    minPrice: number = 0.0,
    maxPrice: number = 9999999999.0,
    search: string = ''
  ): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      // console.log('getMostReviewedProducts: Using token:', token ? 'Token exists' : 'No token');
      
      // Validate categoryIds
      if (!Array.isArray(categoryIds) || categoryIds.length === 0) {
        console.warn('No category IDs provided for most reviewed products');
        // Fallback to local database with all products
        const result = await LocalDB.getMostReviewedProducts(
          categoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Most reviewed products retrieved successfully from local database',
        };
      }
      
      // Filter out invalid category IDs
      const validCategoryIds = categoryIds.filter(id => id !== undefined && id !== null);
      if (validCategoryIds.length === 0) {
        console.warn('No valid category IDs provided for most reviewed products');
        // Fallback to local database
        const result = await LocalDB.getMostReviewedProducts(
          categoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Most reviewed products retrieved successfully from local database',
        };
      }
      
      // Construct the API URL with all query parameters
      const params = new URLSearchParams({
        offset: offset.toString(),
        limit: limit.toString(),
        type,
        filter,
        rating_count: ratingCount,
        min_price: minPrice.toString(),
        max_price: maxPrice.toString(),
        search
      });
      
      // Add category_ids as JSON string
      params.append('category_ids', JSON.stringify(validCategoryIds));
      
      const url = `${API_BASE_URL}/items/most-reviewed?${params.toString()}`;
      
      console.log('Sending get most reviewed products request to:', url);
      
      // Send request using Axios
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });
      
      // console.log('Response status:', response.status);
      // console.log('Most reviewed Response data:', response.data);
      
      // Check if response data exists and is not empty
      if (!response.data) {
        // console.log('No response data received, falling back to local database');
        // Fallback to local database
        const result = await LocalDB.getMostReviewedProducts(
          validCategoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Most reviewed products retrieved successfully from local database',
        };
      }
      
      // Parse the response data if it's a string
      let parsedData = response.data;
      if (typeof parsedData === 'string') {
        // Check if string is empty or whitespace only
        if (!parsedData.trim()) {
          // console.log('Empty response data received, falling back to local database');
          // Fallback to local database
          const result = await LocalDB.getMostReviewedProducts(
            validCategoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
          );
          return {
            success: true,
            data: { products: result.data, categories: [] },
            message: 'Most reviewed products retrieved successfully from local database',
          };
        }
        
        let jsonText = parsedData.trim();
        if (!jsonText.endsWith('}')) {
          jsonText += '}';
        }
        try {
          parsedData = JSON.parse(jsonText);
        } catch (parseError) {
          console.error('Error parsing response data:', parseError);
          // console.log('Raw response data:', parsedData);
          // Fallback to local database
          const result = await LocalDB.getMostReviewedProducts(
            validCategoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
          );
          return {
            success: true,
            data: { products: result.data, categories: [] },
            message: 'Most reviewed products retrieved successfully from local database',
          };
        }
      }
      
      // Ensure we have the proper structure
      if (parsedData && typeof parsedData === 'object' && !parsedData.products) {
        // If we have a flat structure, wrap it properly
        parsedData = {
          products: Array.isArray(parsedData) ? parsedData : [],
          categories: []
        };
      }
      
      return {
        success: true,
        data: parsedData,
        message: 'Most reviewed products retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get most reviewed products error, falling back to local database:', error);
      
      // Fallback to local database when API fails
      try {
        const result = await LocalDB.getMostReviewedProducts(
          categoryIds, offset, limit, type, filter, ratingCount, minPrice, maxPrice, search
        );
        return {
          success: true,
          data: { products: result.data, categories: [] },
          message: 'Most reviewed products retrieved successfully from local database',
        };
      } catch (localError) {
        console.error('Local database error:', localError);
        return {
          success: false,
          message: `Failed to get most reviewed products: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },

  // Delete a product
  deleteProduct: async (productId: string): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending product delete request to:', `${API_BASE_URL}/vendor/item/delete`);
      // console.log('Product ID:', productId);
      
      // Send DELETE request using Axios with proper DELETE method
      const config: AxiosRequestConfig = {
        method: 'DELETE',
        url: `${API_BASE_URL}/vendor/item/delete`,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
  },
  {
    method: 'POST',
    url: '/api/products',
    data: {
      id: productId
    },
  },
};

      
      const response = await axios(config);
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      // After successful deletion, refresh the products list
      // This will be handled by the onSuccess callback in the mutation
      
      return {
        success: true,
        data: response.data,
        message: response.data.message || 'Product deleted successfully',
      };
    } catch (error: any) {
      console.error('Delete product error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to delete product. Status: ${error.response.status}`,
          data: null,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },
};

// Categories API
export const categoriesApi = {
  // Get all categories
  getCategories: async (): Promise<ApiResponse<any[]>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending get categories request to:', `${API_BASE_URL}/categories`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/categories`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data type:', typeof response.data);
      // console.log('Response data:', response.data);
      // console.log('Is response.data an array?', Array.isArray(response.data));
      
      // Handle empty or invalid responses
      if (!response.data) {
        console.warn('Categories API returned no data');
        return {
          success: true, // Changed to true since empty array is a valid response
          message: 'No categories data received',
          data: [],
        };
      }
      
      // Handle different response formats
      let categoriesData = response.data;
      
      // If it's a string, try to parse it
      if (typeof categoriesData === 'string') {
        if (!categoriesData.trim()) {
          // Empty string
          categoriesData = [];
        } else {
          let jsonText = categoriesData.trim();
          if (!jsonText.endsWith('}')) {
            jsonText += '}';
          }
          try {
            categoriesData = JSON.parse(jsonText);
          } catch (parseError) {
            console.error('Error parsing categories data as JSON:', parseError);
            console.log('Raw categories data:', response.data);
            return {
              success: false,
              message: 'Invalid response format from server',
              data: [],
            };
          }
        }
      }
      
      // Ensure we're returning an array
      if (!Array.isArray(categoriesData)) {
        // Handle case where response.data might be an object with a categories property
        if (typeof categoriesData === 'object' && categoriesData.categories && Array.isArray(categoriesData.categories)) {
          categoriesData = categoriesData.categories;
        } 
        // Handle case where response.data is a single category object
        else if (typeof categoriesData === 'object' && categoriesData.id !== undefined) {
          categoriesData = [categoriesData];
        }
        // Handle other object types by converting to array
        else if (typeof categoriesData === 'object' && Object.keys(categoriesData).length > 0) {
          // Try to extract categories from the object
          const keys = Object.keys(categoriesData);
          // If it has numeric keys, it might be an array-like object
          if (keys.every(key => !isNaN(Number(key)))) {
            categoriesData = Object.values(categoriesData);
          } else {
            // Convert single object to array
            categoriesData = [categoriesData];
          }
        } else {
          console.warn('Categories data is not an array and cannot be converted, returning empty array');
          categoriesData = [];
        }
      }
      
      // Validate that each category has at least an id or name
      const validCategories = categoriesData.filter((cat: any) => 
        cat && (cat.id !== undefined || cat.name !== undefined)
      );
      
      if (validCategories.length === 0 && categoriesData.length > 0) {
        console.warn('No valid categories found after validation, but keeping original data');
        // Return original data instead of filtering it out completely
        return {
          success: true,
          data: categoriesData,
          message: 'Categories retrieved successfully',
        };
      }
      
      return {
        success: true,
        data: validCategories.length > 0 ? validCategories : categoriesData,
        message: 'Categories retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get categories error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get categories. Status: ${error.response.status}`,
          data: [],
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: [],
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: [],
        };
      }
    }
  },

  // Get category by ID
  getCategoryById: async (id: string): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending get category by ID request to:', `${API_BASE_URL}/categories/${id}`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/categories/${id}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Category retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get category by ID error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get category. Status: ${error.response.status}`,
          data: null,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },

  // Get child categories by parent ID
  getChildCategories: async (parentId: number): Promise<ApiResponse<any[]>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending get child categories request to:', `${API_BASE_URL}/categories/childes/${parentId}`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/categories/childes/${parentId}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data type:', typeof response.data);
      // console.log('Response data:', response.data);
      // console.log('Is response.data an array?', Array.isArray(response.data));
      
      // Ensure we're returning an array
      let childCategoriesData = response.data;
      if (!Array.isArray(childCategoriesData)) {
        console.warn('Child categories data is not an array, wrapping in array');
        childCategoriesData = [childCategoriesData];
      }
      
      return {
        success: true,
        data: childCategoriesData,
        message: 'Child categories retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get child categories error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get child categories. Status: ${error.response.status}`,
          data: [],
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: [],
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: [],
        };
      }
    }
  },
};

// Users API
export const usersApi = {
  // Get all users
  getUsers: async (): Promise<ApiResponse<User[]>> => {
    const result = await LocalDB.getUsers();
    return {
      success: true,
      data: result.data,
    };
  },

  // Get user by ID
  getUserById: async (id: string): Promise<ApiResponse<User>> => {
    try {
      const result = await LocalDB.getUserById(id);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'User not found',
        data: null as any,
      };
    }
  },

  // Create user
  createUser: async (userData: Omit<User, 'id'>): Promise<ApiResponse<User>> => {
    try {
      const result = await LocalDB.createUser(userData);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to create user',
        data: null as any,
      };
    }
  },

  // Update user
  updateUser: async (id: string, userData: Partial<User>): Promise<ApiResponse<User>> => {
    try {
      const result = await LocalDB.updateUser(id, userData);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to update user',
        data: null as any,
      };
    }
  },
};

// Sellers API
export const sellersApi = {
  // Get all sellers
  getSellers: async (): Promise<ApiResponse<Seller[]>> => {
    const result = await LocalDB.getSellers();
    return {
      success: true,
      data: result.data,
    };
  },

  // Get seller by ID
  getSellerById: async (id: string): Promise<ApiResponse<Seller>> => {
  },

  // Create seller
  createSeller: async (sellerData: Omit<Seller, 'id'>): Promise<ApiResponse<Seller>> => {
    try {
      const token = await getStoredToken();
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }

      // Send request using Axios with proper typing
      const response = await axios.post(
        `${API_BASE_URL}/seller/register`,
        sellerData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );

      return {
        success: true,
        data: response.data,
        message: 'Seller created successfully',
      };
    } catch (error: any) {
      console.error('Create seller error:', error);

      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to create seller. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Update seller
  updateSeller: async (id: string, sellerData: Partial<Seller>): Promise<ApiResponse<Seller>> => {
    try {
      const token = await getStoredToken();
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }

      // Send request using Axios with proper typing
      const response = await axios.put(
        `${API_BASE_URL}/seller/update`,
        { ...sellerData, id },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );

      return {
        success: true,
        data: response.data,
        message: 'Seller updated successfully',
      };
    } catch (error: any) {
      console.error('Update seller error:', error);

      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to update seller. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Delete seller
  deleteSeller: async (id: string) => {
    try {
      const token = await getStoredToken();
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }

      // Send request using Axios with proper typing
      const response = await axios.delete(
        `${API_BASE_URL}/seller/delete/${id}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        }
      );

      return {
        success: true,
        data: response.data,
        message: 'Seller deleted successfully',
      };
    } catch (error: any) {
      console.error('Delete seller error:', error);

      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to delete seller. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },
};

// Orders API
export const ordersApi = {
  // Get all orders
  getOrders: async (): Promise<ApiResponse<Order[]>> => {
    const result = await LocalDB.getOrders();
    return {
      success: true,
      data: result.data,
    };
  },

  // Get order by ID
  getOrderById: async (id: string): Promise<ApiResponse<Order>> => {
    try {
      const result = await LocalDB.getOrderById(id);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Order not found',
        data: null as any,
      };
    }
  },

  // Create order
  createOrder: async (orderData: Omit<Order, 'id'>): Promise<ApiResponse<Order>> => {
    try {
      const result = await LocalDB.createOrder(orderData);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to create order',
        data: null as any,
      };
    }
  },

  // Update order
  updateOrder: async (id: string, orderData: Partial<Order>): Promise<ApiResponse<Order>> => {
    try {
      const result = await LocalDB.updateOrder(id, orderData);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to update order',
        data: null as any,
      };
    }
  },
};

// Shipping API
export const shippingApi = {
  // Get shipping services
  getShippingServices: async (): Promise<ApiResponse<ShippingService[]>> => {
    try {
      const token = await getStoredToken();
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }

      // Send request using Axios with proper typing
      const response = await axios.get(
        `${API_BASE_URL}/shipping-service/services`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        }
      );

      return {
        success: true,
        data: response.data,
        message: 'Shipping services retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get shipping services error:', error);

      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get shipping services. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Get shipping service by ID
  getShippingServiceById: async (serviceId: number): Promise<ApiResponse<ShippingService>> => {
    try {
      const token = await getStoredToken();
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }

      // Send request using Axios with proper typing
      const response = await axios.get(
        `${API_BASE_URL}/shipping-service/service/${serviceId}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        }
      );

      return {
        success: true,
        data: response.data,
        message: 'Shipping service retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get shipping service by ID error:', error);

      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get shipping service. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Create shipping service
  createShippingService: async (serviceData: Omit<ShippingService, 'id'>): Promise<ApiResponse<ShippingService>> => {
    try {
      const token = await getStoredToken();
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }

      // Send request using Axios with proper typing
      const response = await axios.post(
        `${API_BASE_URL}/shipping-service/service`,
        serviceData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );

      return {
        success: true,
        data: response.data,
        message: 'Shipping service created successfully',
      };
    } catch (error: any) {
      console.error('Create shipping service error:', error);

      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to create shipping service. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Update shipping service
  updateShippingService: async (serviceId: number, serviceData: Partial<ShippingService>): Promise<ApiResponse<ShippingService>> => {
    try {
      const token = await getStoredToken();
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }

      // Send request using Axios with proper typing
      const response = await axios.put(
        `${API_BASE_URL}/shipping-service/service/${serviceId}`,
        serviceData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );

      return {
        success: true,
        data: response.data,
        message: 'Shipping service updated successfully',
      };
    } catch (error: any) {
      console.error('Update shipping service error:', error);

      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to update shipping service. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Delete shipping service
  deleteShippingService: async (serviceId: number) => { 
    try {
      const token = await getStoredToken();
      // console.log('Deleting shipping service with ID:', serviceId);
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }
      // Add implementation for deleting shipping service
      const response = await axios.delete(`${API_BASE_URL}/shipping-service/service/${serviceId}/delete`, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      });
      return {
        success: true,
        message: 'Shipping service deleted successfully',
        data: null,
      };
    } catch (error: any) {
      console.error('Delete shipping service error:', error);
      if (error.response) {
        // Server responded with error status
        console.error('Error response data:', error.response.data);
        console.error('Error response status:', error.response.status);
        console.error('Error response headers:', error.response.headers);
        
        return {
          success: false,
          message: error.response.data.message || `Failed to Delete shipping service. Status: ${error.response.status}`,
          data: null as any,
        };
      }else if (error.request) {
        // Request was made but no response received
        console.error('Error request:', error.request);
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        console.error('Unexpected error:', error.message);
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Cart API
  cartApi: {
    // Add item to cart
    addToCart: async (itemId: number, quantity: number, variation: number): Promise<ApiResponse<any>> => {
      try {
        const token = await getStoredToken();
        
        if (!token) {
          return {
            success: false,
            message: 'Authentication required. Please log in first.',
            data: null,
          };
        }
        
        const response = await axios.post(
          `${API_BASE_URL}/customer/cart/add`,
          { item_id: itemId, quantity, variation },
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );
        
        return {
          success: true,
          data: response.data,
          message: 'Item added to cart successfully',
        };
      } catch (error: any) {
        console.error('Add to cart error:', error);
        
        if (error.response) {
          return {
            success: false,
            message: error.response.data.message || `Failed to add item to cart. Status: ${error.response.status}`,
            data: null,
          };
        } else if (error.request) {
          return {
            success: false,
            message: 'Network error. Please check your connection and try again.',
            data: null,
          };
        } else {
          return {
            success: false,
            message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
            data: null,
          };
        }
      }
    },

    // Get cart items
    getCart: async (): Promise<ApiResponse<any[]>> => {
      try {
        const token = await getStoredToken();
        
        if (!token) {
          return {
            success: false,
            message: 'Authentication required. Please log in first.',
            data: [],
          };
        }
        
        const response = await axios.get(
          `${API_BASE_URL}/customer/cart/list`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );
        
        return {
          success: true,
          data: response.data,
          message: 'Cart items retrieved successfully',
        };
      } catch (error: any) {
        console.error('Get cart error:', error);
        
        if (error.response) {
          return {
            success: false,
            message: error.response.data.message || `Failed to get cart items. Status: ${error.response.status}`,
            data: [],
          };
        } else if (error.request) {
          return {
            success: false,
            message: 'Network error. Please check your connection and try again.',
            data: [],
          };
        } else {
          return {
            success: false,
            message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
            data: [],
          };
        }
      }
    },

    // Update cart item
    updateCartItem: async (cartId: number, quantity: number, variation: number): Promise<ApiResponse<any>> => {
      try {
        const token = await getStoredToken();
        
        if (!token) {
          return {
            success: false,
            message: 'Authentication required. Please log in first.',
            data: null,
          };
        }
        
        const response = await axios.put(
          `${API_BASE_URL}/customer/cart/update`,
          { cart_id: cartId, quantity, variation },
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );
        
        return {
          success: true,
          data: response.data,
          message: 'Cart item updated successfully',
        };
      } catch (error: any) {
        console.error('Update cart item error:', error);
        
        if (error.response) {
          return {
            success: false,
            message: error.response.data.message || `Failed to update cart item. Status: ${error.response.status}`,
            data: null,
          };
        } else if (error.request) {
          return {
            success: false,
            message: 'Network error. Please check your connection and try again.',
            data: null,
          };
        } else {
          return {
            success: false,
            message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
            data: null,
          };
        }
      }
    },

    // Remove item from cart
    removeFromCart: async (cartId: number): Promise<ApiResponse<any>> => {
      try {
        const token = await getStoredToken();
        
        if (!token) {
          return {
            success: false,
            message: 'Authentication required. Please log in first.',
            data: null,
          };
        }
        
        const response = await axios.post(
          `${API_BASE_URL}/customer/cart/remove-item`,
          { cart_id: cartId },
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );
        
        return {
          success: true,
          data: response.data,
          message: 'Item removed from cart successfully',
        };
      } catch (error: any) {
        console.error('Remove from cart error:', error);
        
        if (error.response) {
          return {
            success: false,
            message: error.response.data.message || `Failed to remove item from cart. Status: ${error.response.status}`,
            data: null,
          };
        } else if (error.request) {
          return {
            success: false,
            message: 'Network error. Please check your connection and try again.',
            data: null,
          };
        } else {
          return {
            success: false,
            message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
            data: null,
          };
        }
      }
    },
  },
};

// Categories API
export const categoriesApi = {
  // Get all categories
  getCategories: async (): Promise<ApiResponse<any[]>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending get categories request to:', `${API_BASE_URL}/categories`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/categories`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data type:', typeof response.data);
      // console.log('Response data:', response.data);
      // console.log('Is response.data an array?', Array.isArray(response.data));
      
      // Handle empty or invalid responses
      if (!response.data) {
        console.warn('Categories API returned no data');
        return {
          success: true, // Changed to true since empty array is a valid response
          message: 'No categories data received',
          data: [],
        };
      }
      
      // Handle different response formats
      let categoriesData = response.data;
      
      // If it's a string, try to parse it
      if (typeof categoriesData === 'string') {
        if (!categoriesData.trim()) {
          // Empty string
          categoriesData = [];
        } else {
          let jsonText = categoriesData.trim();
          if (!jsonText.endsWith('}')) {
            jsonText += '}';
          }
          try {
            categoriesData = JSON.parse(jsonText);
          } catch (parseError) {
            console.error('Error parsing categories data as JSON:', parseError);
            console.log('Raw categories data:', response.data);
            return {
              success: false,
              message: 'Invalid response format from server',
              data: [],
            };
          }
        }
      }
      
      // Ensure we're returning an array
      if (!Array.isArray(categoriesData)) {
        // Handle case where response.data might be an object with a categories property
        if (typeof categoriesData === 'object' && categoriesData.categories && Array.isArray(categoriesData.categories)) {
          categoriesData = categoriesData.categories;
        } 
        // Handle case where response.data is a single category object
        else if (typeof categoriesData === 'object' && categoriesData.id !== undefined) {
          categoriesData = [categoriesData];
        }
        // Handle other object types by converting to array
        else if (typeof categoriesData === 'object' && Object.keys(categoriesData).length > 0) {
          // Try to extract categories from the object
          const keys = Object.keys(categoriesData);
          // If it has numeric keys, it might be an array-like object
          if (keys.every(key => !isNaN(Number(key)))) {
            categoriesData = Object.values(categoriesData);
          } else {
            // Convert single object to array
            categoriesData = [categoriesData];
          }
        } else {
          console.warn('Categories data is not an array and cannot be converted, returning empty array');
          categoriesData = [];
        }
      }
      
      // Validate that each category has at least an id or name
      const validCategories = categoriesData.filter((cat: any) => 
        cat && (cat.id !== undefined || cat.name !== undefined)
      );
      
      if (validCategories.length === 0 && categoriesData.length > 0) {
        console.warn('No valid categories found after validation, but keeping original data');
        // Return original data instead of filtering it out completely
        return {
          success: true,
          data: categoriesData,
          message: 'Categories retrieved successfully',
        };
      }
      
      return {
        success: true,
        data: validCategories.length > 0 ? validCategories : categoriesData,
        message: 'Categories retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get categories error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get categories. Status: ${error.response.status}`,
          data: [],
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: [],
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: [],
        };
      }
    }
  },

  // Get category by ID
  getCategoryById: async (id: string): Promise<ApiResponse<any>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending get category by ID request to:', `${API_BASE_URL}/categories/${id}`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/categories/${id}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Category retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get category by ID error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get category. Status: ${error.response.status}`,
          data: null,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null,
        };
      }
    }
  },

  // Get child categories by parent ID
  getChildCategories: async (parentId: number): Promise<ApiResponse<any[]>> => {
    try {
      const token = await getStoredToken();
      
      // console.log('Sending get child categories request to:', `${API_BASE_URL}/categories/childes/${parentId}`);
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/categories/childes/${parentId}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data type:', typeof response.data);
      // console.log('Response data:', response.data);
      // console.log('Is response.data an array?', Array.isArray(response.data));
      
      // Ensure we're returning an array
      let childCategoriesData = response.data;
      if (!Array.isArray(childCategoriesData)) {
        console.warn('Child categories data is not an array, wrapping in array');
        childCategoriesData = [childCategoriesData];
      }
      
      return {
        success: true,
        data: childCategoriesData,
        message: 'Child categories retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get child categories error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get child categories. Status: ${error.response.status}`,
          data: [],
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: [],
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: [],
        };
      }
    }
  },
};

// Users API
export const usersApi = {
  // Get all users
  getUsers: async (): Promise<ApiResponse<User[]>> => {
    const result = await LocalDB.getUsers();
    return {
      success: true,
      data: result.data,
    };
  },

  // Get user by ID
  getUserById: async (id: string): Promise<ApiResponse<User>> => {
    try {
      const result = await LocalDB.getUserById(id);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'User not found',
        data: null as any,
      };
    }
  },

  // Create user
  createUser: async (userData: Omit<User, 'id'>): Promise<ApiResponse<User>> => {
    try {
      const result = await LocalDB.createUser(userData);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to create user',
        data: null as any,
      };
    }
  },

  // Update user
  updateUser: async (id: string, userData: Partial<User>): Promise<ApiResponse<User>> => {
    try {
      const result = await LocalDB.updateUser(id, userData);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to update user',
        data: null as any,
      };
    }
  },
};

// Sellers API
export const sellersApi = {
  // Get all sellers
  getSellers: async (): Promise<ApiResponse<Seller[]>> => {
    const result = await LocalDB.getSellers();
    return {
      success: true,
      data: result.data,
    };
  },

  // Get seller by ID
  getSellerById: async (id: string): Promise<ApiResponse<Seller>> => {
    try {
      const result = await LocalDB.getSellerById(id);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Seller not found',
        data: null as any,
      };
    }
  },
};

// Reviews API
export const reviewsApi = {
  // Get product reviews
  getProductReviews: async (
    productId: string,
    page: number = 1,
    limit: number = 10
  ): Promise<PaginatedResponse<Review>> => {
    return await LocalDB.getProductReviews(productId, page, limit);
  },
};

// Stories API
export const storiesApi = {
  // Get all stories
  getStories: async (): Promise<ApiResponse<Story[]>> => {
    const result = await LocalDB.getStories();
    return {
      success: true,
      data: result.data,
    };
  },
};

// Orders API
export const ordersApi = {
  // Create order
  createOrder: async (orderData: Omit<Order, 'id' | 'createdAt' | 'updatedAt'>): Promise<ApiResponse<Order>> => {
    try {
      const result = await LocalDB.createOrder(orderData);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to create order',
        data: null as any,
      };
    }
  },

  // Get user orders
  getUserOrders: async (userId: string): Promise<ApiResponse<Order[]>> => {
    try {
      const result = await LocalDB.getUserOrders(userId);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to get orders',
        data: null as any,
      };
    }
  },

  // Get order by ID
  getOrderById: async (orderId: string): Promise<ApiResponse<Order>> => {
    try {
      const orders = await LocalDB.getUserOrders('1'); // This is a mock implementation
      const order = orders.data.find(o => o.id === orderId);
      if (!order) {
        return {
          success: false,
          message: 'Order not found',
          data: null as any,
        };
      }
      return {
        success: true,
        data: order,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to get order',
        data: null as any,
      };
    }
  },
};

// Notifications API
export const notificationsApi = {
  // Get user notifications
  getUserNotifications: async (userId: string): Promise<ApiResponse<Notification[]>> => {
    try {
      const result = await LocalDB.getUserNotifications(userId);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to get notifications',
        data: null as any,
      };
    }
  },

  // Mark notification as read
  markAsRead: async (notificationId: string): Promise<void> => {
    await LocalDB.markAsRead(notificationId);
  },

  // Mark all notifications as read
  markAllAsRead: async (userId: string): Promise<void> => {
    await LocalDB.markAllAsRead(userId);
  },
};

// Cart API
export const cartApi = {
  // Get user cart
  getCart: async (userId: string): Promise<ApiResponse<CartItem[]>> => {
    try {
      const result = await LocalDB.getCart(userId);
      return {
        success: true,
        data: result.data,
      };
    } catch (error) {
      return {
        success: false,
        message: 'Failed to get cart',
        data: null as any,
      };
    }
  },

  // Add to cart
  addToCart: async (userId: string, product: Product, quantity: number = 1, selectedSize?: string, selectedColor?: any): Promise<void> => {
    await LocalDB.addToCart(userId, product, quantity, selectedSize, selectedColor);
  },

  // Update cart item
  updateCartItem: async (itemId: string, quantity: number): Promise<void> => {
    await LocalDB.updateCartItem(itemId, quantity);
  },

  // Remove from cart
  removeFromCart: async (itemId: string): Promise<void> => {
    await LocalDB.removeFromCart(itemId);
  },

  // Clear cart
  clearCart: async (userId: string): Promise<void> => {
    await LocalDB.clearCart(userId);
  },
};

// Wishlist API - now implemented through useWishlistMutations hook

// Add Store interface
export interface Store {
  id: number;
  name: string;
  phone: string;
  email: string;
  logo: string | null;
  cover_photo: string | null;
  logo_full_url: string | null;
  cover_photo_full_url: string | null;
  address: string | null;
  delivery_time: string;
  rating: number[];
  items_count: number;
  orders_count: number;
  reviews_count: number;
  featured: number;
  active: boolean;
  open: number;
  distance: number | null;
}

// Stores API
export const storesApi = {
  // Get all stores
  getAllStores: async (
    storeType: string = 'all',
    offset: number = 1,
    limit: number = 12
  ): Promise<ApiResponse<{ stores: Store[]; total_size: number }>> => {
    try {
      const token = await getStoredToken();
      
      // Construct the API URL with query parameters
      const url = `${API_BASE_URL}/stores/get-stores/all?store_type=${storeType}&offset=${offset}&limit=${limit}`;
      
      // console.log('Sending get all stores request to:', url);
      
      // Send request using Axios
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      // Check if response data exists and is not empty
      if (!response.data) {
        // console.log('No response data received for stores');
        return {
          success: true,
          data: { stores: [], total_size: 0 },
          message: 'No stores data received',
        };
      }
      
      // Parse the response data if it's a string
      let parsedData = response.data;
      if (typeof parsedData === 'string') {
        // Check if string is empty or whitespace only
        if (!parsedData.trim()) {
          // console.log('Empty response data received for stores');
          return {
            success: true,
            data: { stores: [], total_size: 0 },
            message: 'No stores found',
          };
        }
        let jsonData = parsedData.trim();
        if (!jsonData.endsWith('}')) {
          jsonData += '}';
        }
        try {
          parsedData = JSON.parse(jsonData);
        } catch (parseError) {
          console.error('Error parsing stores response data:', parseError);
          console.log('Raw response data:', response.data);
          return {
            success: false,
            message: 'Invalid response format from server',
            data: null as any,
          };
        }
      }
      
      // Ensure we have the expected structure
      if (!parsedData.stores) {
        // If response is directly an array of stores
        if (Array.isArray(parsedData)) {
          return {
            success: true,
            data: { stores: parsedData, total_size: parsedData.length },
            message: 'Stores retrieved successfully',
          };
        }
        // If response is a single store object
        else if (parsedData.id) {
          return {
            success: true,
            data: { stores: [parsedData], total_size: 1 },
            message: 'Stores retrieved successfully',
          };
        }
        // Unknown format
        else {
          console.warn('Unexpected stores data format:', parsedData);
          return {
            success: true,
            data: { stores: [], total_size: 0 },
            message: 'No valid stores data found',
          };
        }
      }
      
      return {
        success: true,
        data: parsedData,
        message: 'Stores retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get all stores error:', error);
      
      if (error.response) {
        // Server responded with error status
        return {
          success: false,
          message: error.response.data.message || `Failed to get stores. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },
};

// Shipping Services API
export const shippingServicesApi = {
  // Get shipping services by store ID
  getShippingServices: async (storeId: number): Promise<ApiResponse<ShippingService[]>> => {
    try {
      const token = await getStoredToken();
      
      // Debug: Log token status
      // console.log('Get shipping services - Token:', token ? 'Present' : 'Missing');
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }
      
      // console.log('Sending get shipping services request to:', `${API_BASE_URL}/shipping-service/${storeId}`);
      // console.log('Authorization header:', `Bearer ${token.substring(0, 10)}...`); // Log first 10 chars of token for debugging
      
      // Send request using Axios
      const response = await axios.get(
        `${API_BASE_URL}/shipping-service/${storeId}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Shipping services retrieved successfully',
      };
    } catch (error: any) {
      console.error('Get shipping services error:', error);
      
      if (error.response) {
        // Server responded with error status
        console.error('Error response data:', error.response.data);
        console.error('Error response status:', error.response.status);
        console.error('Error response headers:', error.response.headers);
        
        return {
          success: false,
          message: error.response.data.message || `Failed to get shipping services. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        console.error('Error request:', error.request);
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        console.error('Unexpected error:', error.message);
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Create a new shipping service
  createShippingService: async (serviceData: Omit<ShippingService, 'id' | 'created_at' | 'updated_at'>): Promise<ApiResponse<ShippingService>> => {
    try {
      const token = await getStoredToken();
      
      // Debug: Log token status
      console.log('Shipping service creation - Token:', token ? 'Present' : 'Missing');
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }
      
      // Ensure proper type conversion for numeric fields
      const processedServiceData = {
        ...serviceData,
        store_id: toInteger(serviceData.store_id),
        origin_zip: serviceData.origin_zip,
        locations: serviceData.locations.map(location => ({
          ...location,
          one_item: toNumber(location.one_item),
          additional_item: toNumber(location.additional_item)
        }))
      };
      
      // console.log('Sending shipping service creation request to:', `${API_BASE_URL}/shipping-service/store`);
      // console.log('Shipping service data:', processedServiceData);
      // console.log('Authorization header:', `Bearer ${token}`); // Log first 10 chars of token for debugging
      
      // Send request using Axios
      const response = await axios.post(
        `${API_BASE_URL}/shipping-service/store`,
        processedServiceData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            // 'Authorization' : 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI1IiwianRpIjoiOTcwMmJjYjRmMTQwNTRlZjg0YzM3ZWI2NDVhMTk3YTNlZWMzOWNhNjI2Y2NkNmRmYzExNmI0ZmNmODcxMmQxM2E3Mjc4MGM3MjU5ZWUwZTgiLCJpYXQiOjE3NjAxNjM5NDkuNzQ1OTk5LCJuYmYiOjE3NjAxNjM5NDkuNzQ2MDAyLCJleHAiOjE3OTE2OTk5NDkuNjE4MjE5LCJzdWIiOiIxMDAxMiIsInNjb3BlcyI6W119.JD2qRpnI5PJkXwUKLuuqI1fw2LYqD5Ppq5PyJICMfzzxEoCQMo9u8qWa8_naAIuEFLtZsSgoSjqDJGuass9PCMzPrugPmuDsRxF-ljI0VLWlS2uvqfBO-RwjL8Dw3MZsOLoFqZIHhglHDi6oAYvQ2faGWSqMZVicroK6gM4DA3jsND4kHwgysxuAV27MhW5EmVUFckjbE2xhUA08f_3Pl66NO57JBu7eh8rhaRkGlVAB3_H85fhqC8eFjqSCZWwLBJryh9ITfrvYnGuyi_x15tq9sqkXMjEQnM17lNuaNrxnTwFGCFrlfG3qzvYG6cGmSZRvZOu6ERjE4E0CZRqJdOewxfKye6aLRH1rLZumJQ19GvqJRMJKAARnG6rFEa0306lSEwKm09yWjuQqcSctnCUtqos6e7T_H6J8RdKYirFO31xlp9I_JcRkyMYOnBePhg4gDloDoKvT0Aou1DlLzfXcQDIPaFZX2fvhlLp2nX43bctT1zTnDs8ljIqMIR0IMfncO7RADHX8dAX6d_D2YGGCZ_iMANm3-ku_o1tztxeqrC6ERjG-gTYgPMQrCcHgBtUMIhijq01cslcl4XmbShe4h6l7D6dfx-TU9V0ZzMPbr32PSZWAGtbZZLZAteKEj3qulJJ6GJ0U-CKUukMdKiMxOcHZfEca-VUnrY6s4e4',
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Shipping service created successfully',
      };
    } catch (error: any) {
      console.error('Create shipping service error:', error);
      
      if (error.response) {
        // Server responded with error status
        console.error('Error response data:', error.response.data);
        console.error('Error response status:', error.response.status);
        console.error('Error response headers:', error.response.headers);
        
        return {
          success: false,
          message: error.response.data.message || `Failed to create shipping service. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        console.error('Error request:', error.request);
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        console.error('Unexpected error:', error.message);
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  // Update an existing shipping service
  updateShippingService: async (serviceId: number, serviceData: Omit<ShippingService, 'id' | 'created_at' | 'updated_at'>): Promise<ApiResponse<ShippingService>> => {
    try {
      const token = await getStoredToken();
      
      // Debug: Log token status
      // console.log('Shipping service update - Token:', token ? 'Present' : 'Missing');
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }
      
      // Ensure proper type conversion for numeric fields
      const processedServiceData = {
        ...serviceData,
        store_id: toInteger(serviceData.store_id),
        origin_zip: serviceData.origin_zip,
        locations: serviceData.locations.map(location => ({
          ...location,
          one_item: toNumber(location.one_item),
          additional_item: toNumber(location.additional_item)
        }))
      };
      
      // console.log('Sending shipping service update request to:', `${API_BASE_URL}/shipping-service/${serviceId}`);
      // console.log('Shipping service data:', processedServiceData);
      // console.log('Authorization header:', `Bearer ${token.substring(0, 10)}...`); // Log first 10 chars of token for debugging
      
      // Send request using Axios with PUT method
      const response = await axios.put(
        `${API_BASE_URL}/shipping-service/${serviceId}/update`,
        processedServiceData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      // console.log('Response status:', response.status);
      // console.log('Response data:', response.data);
      
      return {
        success: true,
        data: response.data,
        message: 'Shipping service updated successfully',
      };
    } catch (error: any) {
      console.error('Update shipping service error:', error);
      
      if (error.response) {
        // Server responded with error status
        console.error('Error response data:', error.response.data);
        console.error('Error response status:', error.response.status);
        console.error('Error response headers:', error.response.headers);
        
        return {
          success: false,
          message: error.response.data.message || `Failed to update shipping service. Status: ${error.response.status}`,
          data: null as any,
        };
      } else if (error.request) {
        // Request was made but no response received
        console.error('Error request:', error.request);
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        console.error('Unexpected error:', error.message);
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },

  deleteShippingService: async (serviceId: number) => { 
    try {
      const token = await getStoredToken();
      // console.log('Deleting shipping service with ID:', serviceId);
      if (!token) {
        return {
          success: false,
          message: 'Authentication required. Please log in first.',
          data: null as any,
        };
      }
      // Add implementation for deleting shipping service
      const response = await axios.delete(`${API_BASE_URL}/shipping-service/service/${serviceId}/delete`, {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      });
      return {
        success: true,
        message: 'Shipping service deleted successfully',
        data: null,
      };
    } catch (error: any) {
      console.error('Delete shipping service error:', error);
      if (error.response) {
        // Server responded with error status
        console.error('Error response data:', error.response.data);
        console.error('Error response status:', error.response.status);
        console.error('Error response headers:', error.response.headers);
        
        return {
          success: false,
          message: error.response.data.message || `Failed to Delete shipping service. Status: ${error.response.status}`,
          data: null as any,
        };
      }else if (error.request) {
        // Request was made but no response received
        console.error('Error request:', error.request);
        return {
          success: false,
          message: 'Network error. Please check your connection and try again.',
          data: null as any,
        };
      } else {
        // Something else happened
        console.error('Unexpected error:', error.message);
        return {
          success: false,
          message: `Unexpected error: ${error.message || 'Unknown error occurred'}`,
          data: null as any,
        };
      }
    }
  },
};
